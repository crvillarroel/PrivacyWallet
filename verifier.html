<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Verifiable Credentials for a Safe Island">
    <title>Safe Island</title>

    <!-- Bootstrap 4 CSS -->
    <link rel="stylesheet" href="css/bootstrap.min.css">

    <!-- Bootstrap 4 Icons -->
    <link rel="stylesheet" href="css/bootstrap-icons.css">


    <!-- Specific CSS for this project -->
    <!-- <link rel="stylesheet" href="css/safeisland.css"> -->
    <!-- <link rel="stylesheet" href="css/safeislandmdb.css"> -->

    <!-- <link rel="manifest" href="/manifest.json"> -->

    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="SafeIsland">
    <link rel="apple-touch-icon" href="img/icon-152.png">

    <!-- Specific styles for the application -->
    <style>
        .jrmpage {
            display: none;
        }

        .containerjrm {
            margin: auto;
        }

        .navbar.fixed-bottom {
            justify-content: space-around;
            margin: auto;
        }

        @media (min-width: 576px) {

            .containerjrm,
            .navbar.fixed-bottom {
                max-width: 540px;
            }
        }

        @media (min-width: 768px) {

            .containerjrm,
            .navbar.fixed-bottom {
                max-width: 720px;
            }
        }

        #issuerHome p {
            margin-bottom: 0;
            font-size: 0.8rem;
        }

        .placeHolder p {
            margin-bottom: 0;
        }

        .etiqueta {
            font-size: 1rem;
            margin-bottom: 0;
        }

        .valor {
            font-size: 1.3rem;
            font-weight: 500;
            margin-bottom: 0.4rem;
        }


        .fab {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            box-shadow: 0 6px 10px 0 #666;
            color: white;
            font-size: 50px;
            text-align: center;
            line-height: 70px;
            position: fixed;
            bottom: 2rem;
            right: 1.5rem;

        }

        #header {
            margin-bottom: 0.7rem;

        }

        #realplaceholderQR {
            display: block;
            margin-left: auto;
            margin-right: auto;
        }

        a,
        button,
        h4,
        p {
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
        }

        /* .verified {
            background-color: #d4edda;
        }

        .failed {
            background-color: #f8d7da;
        } */

        .logging {
            font-size: 0.8rem;
            margin-bottom: 0;
            font-family: monospace;
        }

        .loggingError {
            color: red;
            font-size: 0.8rem;
            font-weight: 500;
            margin-bottom: 0;
            font-family: monospace;
        }

        #butInstall {
            background-color: blue;
        }

        /* .card-img-top {
            height: 10rem;
        } */

        .key {
            color:crimson;
            font-weight: 700;
        }

        .number {
            color:royalblue;
            font-weight: 500;
        }

        .string {
            color:green;
            font-weight: 500;
        }

    </style>

</head>

<body>

    <script>

        // This is the first javascript code executed in the application, even before
        // The html is executed. The code should be kept to a minimum.

        // This is the array of pages in the application
        // Each page should register a handler to execute pageEnter transitions
        // registration is done at each page definition
        var pages = {}

        // The app can be invoked in different ways:
        // 1. Just the domain name. This is the default and the functionality is the
        //   passenger wallet, implemented in te file "index.html".
        // 2. As "verifier.html" or "pubcred.html". Those are files exactly identical to 
        //   the "index.html" but they behave as the name suggests. It is a convenience 
        //   method to invoke the other specialised functionalities.
        // 3. With a URL search parameter "id", like
        //   "https://www.lanzarotesafe.org/?id=123456". In this case, the passenger 
        //   wallet retrieves automatically the VC specified by the "id".
        // 4. Finally, with a URL parameter "page", specifying the page inside the app to
        //   invoke. This is not intended for end-users, but givess access to functionality not accessible otherwise, like the admin screens.

        // Get the pathname
        var mypathname = window.location.pathname

        // Get the search parameters in the URL
        var paramsString = window.location.search
        var searchParams = new URLSearchParams(paramsString);

        if (location.hostname == "safeisland.hesusruiz.org") {
            let pubid = searchParams.get("pubid")
            if (pubid) {
                let newLocation = "https://www.lanzarotesafe.org/?pubid=" + pubid
                console.log(newLocation)
                window.location.replace(newLocation)
            }
        }


        // And get the page if the user specified it
        let page = searchParams.get("page")

        // The default home page is the Passenger credential list (the wallet)
        var homePage = "#passengerCredList"

        // Check if we have been invoked with another name and set the home page
        if (mypathname.startsWith("/verifier")) {
            homePage = "#verifierScanQR"
        } else if (mypathname.startsWith("/pubcred")) {
            homePage = "#pubcreds"
        } else if (mypathname.startsWith("/admin")) {
            homePage = "#admin"
        } else if (mypathname.startsWith("/demo")) {
            homePage = "#homePage"
        } else if (page) {
            // A "page" URL parameter was specified
            homePage = "#" + page
        }

        // This function hides/displays the headers depending on the page
        function headerBrandBack(flag) {
            if (flag == true) {
                $("#headerBrandNormal").hide()
                $("#headerBrandBack").show()
            } else {
                $("#headerBrandNormal").show()
                $("#headerBrandBack").hide()
            }
        }

        // Screen types for display of QR data
        const ST_PASSENGER_SCAN = "fromPassengerScan"
        const ST_VERIFIER_SCAN = "fromVerifierScan"
        const ST_NORMAL = "normal"

    </script>

    <!-- Use a container to manage margins at different responsive sizes -->
    <div class="containerjrm">

        <!-- We use two headers, displayed/hidden depending on the specific page -->
        <nav id="header" class="navbar navbar-dark bg-primary shadow">

            <!-- The first header is displayed by default and is used for main pages -->
            <div id="headerBrandNormal">
                <a class="navbar-brand" onclick="gotoPage(homePage)">
                    <i class="bi bi-person-square"></i>
                    <span>SafeIsland credentials </span>
                        <button id="butInstall" class="btn btn-sm btn-primary" style="display: none;" type="button">Install</button>
                </a>
            </div>

            <!-- The second header is for pages with a back arrow -->
            <div id="headerBrandBack" style="display:none">
                <a class="navbar-brand" onclick="history.back()">
                    <i class="bi bi-arrow-left"></i>
                    <span>Back</span>
                </a>
            </div>
        </nav>

        <!-- =========================================== -->
        <!-- PUBCRED ENTRY for entities                   -->
        <!-- =========================================== -->
        <script>
            // Register the page function
            pages["#pubcredEntry"] = async function (pageData) {
                mylog("=> Inside pubcredEntry")
            }
        </script>

        <!-- Each page is a simple container with the special class jrmpage -->
        <!-- Page transitions are implemented in javascript hiding all except the one to show -->
        <div id="pubcredEntry" class="jrmpage container">

            <img id="logoPreview" src="" height="200" alt="Image preview" style="display: none;">

            <form class="row g-3">

                <div class="mb-3 col-md-12">
                  <label for="logoFile" class="form-label">Logo file</label>
                  <input type="file" accept=".jpg, .png" onchange="previewFile()" class="form-control" id="logoFile" aria-describedby="logoHelp">
                </div>

                <div class="mb-3 col-md-12">
                  <label for="name" class="form-label">Entity</label>
                  <input type="text" class="form-control" id="name">
                </div>

                <div class="mb-3 col-md-12">
                    <label for="declName" class="form-label">Name of declaration</label>
                    <input type="text" class="form-control" id="declName" placeholder="ESTABLECIMIENTO Covid Safe Responsable">
                </div>  

                <div class="mb-3 col-md-12">
                    <hr>
                    <p>Declarations</p>

                    <div class="container">
                        <div class="ms-3 form-check">
                            <input class="form-check-input" type="checkbox" value="decl1" id="decl1">
                            <label class="form-check-label" for="decl1">
                                Cumple Protocolos Sanitarios
                            </label>
                        </div>
                        
                        <div class="ms-3 form-check">
                            <input class="form-check-input" type="checkbox" value="decl2" id="decl2">
                            <label class="form-check-label" for="decl2">
                                Cumple Test PcR Q Empleados
                            </label>
                        </div>
                        
                        <div class="ms-3 form-check">
                            <input class="form-check-input" type="checkbox" value="decl3" id="decl3">
                            <label class="form-check-label" for="decl3">
                                Cumple Protocolos PoC
                            </label>
                        </div>
    
                    </div>
    
                    <hr>
                </div>


                <div class="col-6 mb-3">
                    <label for="issued" class="form-label">Issued</label>
                    <input type="date" class="form-control" id="issued">
                </div>

                <div class="col-6 mb-3">
                    <label for="expires" class="form-label">Expires</label>
                    <input type="date" class="form-control" id="expires">
                </div>

  
                <div class="container">
                    <a onclick="displayPubCred()" class="btn btn-primary">Preview</a>
                </div>
              </form>


        </div><!-- /page -->

        <script>
            function previewFile() {
                const preview = document.querySelector('#logoPreview');

                // files that user has chosen
                var all_files = document.querySelector('#logoFile').files;
                if(all_files.length == 0) {
                    alert('Error : No file selected');
                    return;
                }

                // first file selected by user
                var file = all_files[0];

                // files types allowed
                console.log("File type", file.type)
                var allowed_types = [ 'image/png', 'image/jpg', 'image/jpeg' ];
                if(allowed_types.indexOf(file.type) == -1) {
                    alert(`Error : Incorrect file type ${file.type}`);
                    return;
                }

                // Max 2 MB allowed
                var max_size_allowed = 2*1024*1024
                if(file.size > max_size_allowed) {
                    alert('Error : Exceeded size 2MB');
                    return;
                }

                // file validation is successfull
                // we will now read the file

                const reader = new FileReader();

                reader.addEventListener("load", function () {
                    // convert image file to base64 string
                    preview.src = reader.result;
                    preview.style.display = "block"
                }, false);

                if (file) {
                    reader.readAsDataURL(file);
                }
            }

            function displayPubCred() {

                let pubcredLogo = document.querySelector('#logoPreview').src
                document.querySelector("#pubcredLogo").src = pubcredLogo

                let pubcredTitle = document.querySelector("#declName").value
                document.querySelector("#pubcredTitle").innerHTML = pubcredTitle

                let pubcredLi1 = document.querySelector("#decl1").checked
                console.log("List item 1:", pubcredLi1)
                if (pubcredLi1) {
                    document.querySelector("#pubcredLi1").innerHTML = "Cumple Protocolos Sanitarios"
                }

                let pubcredLi2 = document.querySelector("#decl2").checked
                if (pubcredLi2) {
                    document.querySelector("#pubcredLi2").innerHTML = "Cumple Test PcR Q Empleados"
                }

                let pubcredLi3 = document.querySelector("#decl3").checked
                if (pubcredLi3) {
                    document.querySelector("#pubcredLi3").innerHTML = "Cumple Protocolo PoCs"
                }

                let pubcredIssued = document.querySelector("#issued").value
                document.querySelector("#pubcredIssued").innerHTML = pubcredIssued

                let pubcredExpires = document.querySelector("#expires").value
                document.querySelector("#pubcredExpires").innerHTML = pubcredExpires

                gotoPage("#pubcred")
            }

        </script>


        <!-- =========================================== -->
        <!-- PUBCRED PAGE for entities                   -->
        <!-- =========================================== -->
        <script>
            // Register the page function
            pages["#pubcred"] = async function (pageData) {
                mylog("=> Inside pubcred")
            }
        </script>

        <!-- Each page is a simple container with the special class jrmpage -->
        <!-- Page transitions are implemented in javascript hiding all except the one to show -->
        <div id="pubcred" class="jrmpage container">

            <div class="card my-3 shadow">
                <img id="pubcredLogo" src="" class="card-img-top">

                <div class="card-body">
                    <h5 id="pubcredTitle" class="card-title">ESTABLECIMIENTO Covid Safe Responsable</h5>
                </div>

                <!-- <ul class="list-group list-group-flush">
                    <li id="pubcredLi1" class="list-group-item"></li>
                    <li id="pubcredLi2" class="list-group-item"></li>
                    <li id="pubcredLi3" class="list-group-item"></li>
                </ul> -->

                <ul>
                    <li id="pubcredLi1"></li>
                    <li id="pubcredLi2"></li>
                    <li id="pubcredLi3"></li>
                </ul>

                <div class="card-body">
                    <p><strong>Issued: <span id="pubcredIssued"></span></strong></p>
                    <p><strong>Expires: <span id="pubcredExpires"></span></strong></p>
                </div>

                <div class="card-body">
                    <a href="#" class="card-link">Ir a la web</a>
                </div>

            </div>



        </div><!-- /page -->




        <!-- =========================================== -->
        <!-- HOME PAGE for demos. It has the three roles -->
        <!-- and the user can choose                     -->
        <!-- =========================================== -->
        <script>
            // Register the page function
            pages["#homePage"] = async function (pageData) {
                mylog("=> Inside home")
            }
        </script>

        <!-- Each page is a simple container with the special class jrmpage -->
        <!-- Page transitions are implemented in javascript hiding all except the one to show -->
        <div id="homePage" class="jrmpage container">

            <!-- The demo page has three cards acting as huge buttons of a menu -->
            <div class="card my-3 shadow">
                <a onclick="gotoPage('#passengerCredList')">
                    <div class="card-body">
                        <h4 class="card-title">I am a Passenger</h4>
                        <p>Receive or show your test results</p>
                    </div>
                </a>
            </div>

            <div class="card my-3 shadow">
                <a onclick="gotoPage('#verifierScanQR')">
                    <div class="card-body">
                        <h4 class="card-title">I am a Verifier</h4>
                        <p>Review the test results of a passenger</p>
                    </div>
                </a>
            </div>

            <div class="card my-3 shadow">
                <a onclick="gotoPage('#issuerHome')">
                    <div class="card-body">
                        <h4 class="card-title">I am an Issuer</h4>
                        <p>Check my lab test results</p>
                    </div>
                </a>
            </div>

            <div class="card my-3 shadow">
                <a onclick="gotoPage('#pubcreds')">
                    <div class="card-body">
                        <h4 class="card-title">Public Credentials</h4>
                        <p>Query the public credentials</p>
                    </div>
                </a>
            </div>

        </div><!-- /page -->


        <!-- =========================================== -->
        <!-- PASSENGER CREDENTIAL LIST PAGE              -->
        <!-- =========================================== -->
        <script>
            pages["#passengerCredList"] = async function (pageData) {
                mylog("=> Inside #passengerCredList")
                // Populate the credential list in the page
                let element = document.querySelector('#passengerCredList #passenger_cred_list');
                await fillPassengerCredList(element);
            }

        </script>

        <div id="passengerCredList" class="jrmpage container">

            <!-- This is a placeholder that will fillPassengerCredList function -->
            <div id="passenger_cred_list"></div>

            <div class="fab bg-primary" onclick="callScannerPage()">
                <i class="bi bi-plus"></i>
            </div>

        </div><!-- /page -->


        <script>

            async function fillPassengerCredList(element) {
                // Fill the DOM of the verifier page with the received HTML

                // Get the keys of all credentials in the database
                let keys = await credentialsGetAllKeys();

                // Count the number of valid credentials
                let validCredentials = 0

                // Do nothing if there are no credentials
                if (keys.length == 0) {
                    element.innerHTML = "<h4>Currently you do not have credentials.</h4>"
                    return;
                }

                // Display all credentials, taking care of the different types
                html = ""
                for (let i = 0; i < keys.length; i++) {

                    let key = keys[i]

                    // Retrieve the credential and extract its components
                    let credential = await credentialsGet(key);

                    // Check if valid credential
                    if (!credential) {
                        myerror("Invalid credential for key", key)
                        continue;
                    }

                    let credentialType = credential["type"]
                    let credentialDecoded = credential["decoded"]
                    if (!credentialType || !credentialDecoded) {
                        myerror("type or decoded fields not found in credential for key", key)
                        continue;
                    }
                    mylog("Credtype", credentialType)

                    // We support several credential types and subtypes
                    // We will extract data from each type for display in a common format
                    let cred = ""
                    let analysisDate = ""
                    let cred_date = ""
                    let displayName = ""
                    let subjectName = ""
                    let cred_error = undefined

                    if (credentialType == "ukimmigration") {

                        // Credential used by the UK Visa & Immigration services
                        schema = "ukimmigration"
                        displayName = "UK Visa & Immigration"
                        cred = credentialDecoded
                        cred_date = cred["ts"]
                        subjectName = cred["ln"] + " " + cred["fn"]

                    } else {

                        cred_error = decodeJWT(credential["encoded"]).error
                        mylog(`CredError: ${cred_error}`)
                        // The only error we support is expired credential
                        if (cred_error && cred_error != "Expired certificate") {
                            myerror(cred_error)
                            continue;
                        }

                        let schema = credentialDecoded['body']['vc']['credentialSchema']['id']

                        if (schema == "covidTestResult") {
                            displayName = "Covid19 certificate"
                            cred = credentialDecoded['body']['vc']['credentialSubject']['covidTestResult'];
                            analysisDate = cred['analysis']['date']
                            // Format timestamp (milliseconds since epoch) for presentation
                            cred_date = formatDate(analysisDate * 1000)
                            subjectName = cred['patient']['name']
                        }

                        if (schema == "vaccinationCredential") {
                            displayName = "Vaccination certificate"
                            cred = credentialDecoded['body']['vc']['credentialSubject']['vaccinationCredential'];
                            analysisDate = cred['vaccination']['date']
                            // Format timestamp (milliseconds since epoch) for presentation
                            cred_date = formatDate(analysisDate * 1000)
                            subjectName = cred['patient']['name']
                        }

                        if (schema == "publicCredential") {
                            cred = credentialDecoded['body']['vc']['credentialSubject']['publicCredential'];
                            cred_date = formatDate(credentialDecoded['body']['iat'] * 1000)
                            displayName = cred['name']
                            subjectName = cred['entity']['name']
                        }


                    }


                    if (cred == "") {
                        myerror("Credential not recognized")
                        return
                    }

                    if (cred_error) {
                        html += `
          <div class="card my-3 shadow failed">
            <a onclick="displayCredentialFromKey('${key}')">
              <div class="card-body">
                <h5 class="card-title">${subjectName}</h5>
                <p>${displayName}</p>
                <p>${cred_date}</p>
                <p>${cred_error}</p>
              </div>
            </a>
          </div>
        `
                    } else {
                        html += `
          <div class="card my-3 shadow">
            <a onclick="displayCredentialFromKey('${key}')">
              <div class="card-body">
                <h5 class="card-title">${subjectName}</h5>
                <p>${displayName}</p>
                <p>${cred_date}</p>
              </div>
            </a>
          </div>
        `
                    }

                }

                element.innerHTML = html;

            }

            async function dbAllCredentials() {

                keys = await dbCredentials.keys();

                // Check if there are keys
                if (keys == null || keys.length == 0) {
                    return null;
                }

                // Sort the array in reverse order: newest first
                keys.sort().reverse();

                return keys

            }

            // Gets one credential from the local DB, sets it as default and switches to the display page 
            async function displayCredentialFromKey(key) {
                console.log(key)
                // Retrieve the credential from the credential store
                credential = await credentialsGet(key)
                await settingsPut("currentCredential", credential)
                mylog("Stored credential", credential)
                gotoPage("#displayCredentialPage", { screenType: ST_NORMAL })
            }

            // Calls the QR scan page
            async function callScannerPage() {
                console.log(window.history.state)
                gotoPage("#passengerQRScan", { caller: "passengerCredList" })
            }

            function formatDate(timestamp) {
                // timestamp: milliseconds since epoch
                ts = new Date(timestamp)

                let year = ts.getFullYear()
                let month = ts.getMonth() + 1
                month = month.toString().padStart(2,"0")
                let day = ts.getDate().toString().padStart(2,"0")
                let hours = ts.getHours().toString().padStart(2,"0")
                let minutes = ts.getMinutes().toString().padStart(2,"0")
                let seconds = ts.getSeconds().toString().padStart(2,"0")

                return `${year}-${month}-${day} ${hours}:${minutes}`;

            }

        </script>


        <!-- ============================================================================
        GENERIC CREDENTIAL DISPLAY PAGE

        Displays any type of credential and can be used from the Passenger, Verifier
        or Issuer screens.
        The buttons displayed on the footer depend on the caller.
        ============================================================================ -->

        <script>
            pages["#displayCredentialPage"] = async function (pageData) {
                mylog("=> Inside #displayCredentialPage", pageData.screenType)
                // Set the arrow back on the header
                headerBrandBack(true)
                var thisPage = document.querySelector("#displayCredentialPage")
                await displayCredentialPage(thisPage, pageData);
            }
        </script>

        <div id="displayCredentialPage" class="jrmpage container">

            <!-- Alert used only by Passenger: display message when new credential received.
                Display a button to save the credential to the local repository -->
            <div id="alertCredentialReceived" class="alert alert-success" style="display:none" role="alert">
                <div class="row">
                    <div class="col-8">
                        You received a credential! Press Save to keep it.
                    </div>
                    <div class="col">
                        <a class="btn btn-primary" onclick="saveCredential();">
                            <i class="bi bi-download"></i>
                            Save
                        </a>
                    </div>
                </div>
            </div>

            <!-- Alert used only by Verifier if verification failed -->
            <div id="alertCredentialFailed" class="alert alert-danger" style="display:none" role="alert">
                <div class="row">
                    <div class="col">
                        <p>Verification failed</p>
                        <p id="failedmsg"></p>
                    </div>
                </div>
            </div>

            <!-- Alert used only by Verified if verification success -->
            <div id="alertCredentialSuccess" class="alert alert-success" style="display:none" role="alert">
                <audio src="img/beep.mp3" style="display: none;"></audio>

                <div class="row">
                    <div class="col">
                        Verification succeeded.
                    </div>
                </div>
            </div>

            <!-- *********************************************************************** -->
            <!-- This the placeholder where the credential will be displayed dynamically -->
            <div id="placeHolder"></div>
            <!-- *********************************************************************** -->

            <!-- The container for the buttons in the footer -->
            <div class="container">

                <!-- The footer is fixed to the bottom. This spacer avoids main content to overlap -->
                <div class="myspacer" style="height: 75px;"></div>

                <nav id="footer" class="navbar fixed-bottom navbar-light bg-light">
                    <a id="backButton" class="btn btn-lg btn-primary shadow" style="display: none;" onclick="history.back()">
                        <i class="bi bi-arrow-clockwise"></i>
                        Scan again
                    </a>
                    <a id="qrButton" class="btn btn-primary shadow" style="display: none;" onclick="qrCredential()">
                        <i class="bi bi-upc-scan"></i>
                        QR
                    </a>
                    <a id="shareButton" class="btn btn-primary shadow" style="display: none;" onclick="gotoPage('#credentialDetailsPage');">
                        <i class="bi bi-zoom-in"></i>
                        Details
                    </a>
                    <a id="deleteButton" class="btn btn-danger shadow" style="display: none;"
                        onclick="confirmDelete();">
                        <i class="bi bi-trash"></i>
                        Delete
                    </a>
                </nav>

            </div>

        </div><!-- /page -->

        <script>
            async function displayCredentialPage(thisPage, pageData) {

                // Populate the credential list in the page

                // Determine the screen type to use, depending on caller
                let screenType = pageData.screenType
                if (screenType == undefined) {
                    screenType = ST_NORMAL
                }

                // Hide all buttons, later enable the ones for the type of page
                thisPage.querySelector('#backButton').style.display = "none";
                thisPage.querySelector('#qrButton').style.display = "none";
                thisPage.querySelector('#shareButton').style.display = "none";
                thisPage.querySelector('#deleteButton').style.display = "none";

                // Hide all alert messages, later enable the correct one
                thisPage.querySelector("#alertCredentialReceived").style.display = "none";
                thisPage.querySelector("#alertCredentialSuccess").style.display = "none";
                thisPage.querySelector("#alertCredentialFailed").style.display = "none";

                // Hide credential background status color
                thisPage.querySelector("#placeHolder").classList.remove("failed")
                thisPage.querySelector("#placeHolder").classList.remove("verified")

                // Get the credential that the caller put in temporary storage
                let credential = await settingsGet("currentCredential")
                if (!credential) {
                    showError("No credential in temporary storage")
                    return;
                }
                mylog("Presenting credential", credential)


                if (screenType == ST_NORMAL) {
                    // Screen used to display user credentials from the local store

                    // Enable the buttons for QR, Share and Delete
                    thisPage.querySelector('#qrButton').style.display = "";
//                    thisPage.querySelector('#shareButton').style.display = "";
                    thisPage.querySelector('#deleteButton').style.display = "";

                }

                if (screenType == ST_PASSENGER_SCAN) {
                    // We are invoked after the passenger has scanned a QR

                    // Enable the alert to allow saving the credential into the store
                    thisPage.querySelector("#alertCredentialReceived").style.display = "";

                }

                if (screenType == ST_VERIFIER_SCAN) {
                    // We are invoked after the verifier has scanned a QR

                    // Enable the Back button
                    thisPage.querySelector('#backButton').style.display = "";

                }

                if (screenType == "fromIssuer") {
                    // We are invoked from the fake Issuer page

                    // Enable the button for QR
                    thisPage.querySelector('#qrButton').style.display = "";
//                    thisPage.querySelector('#shareButton').style.display = "";

                }


                // Get the type of credential we have to display
                // Currently we only process two types: "ukimmigration"
                // and any subtype of "w3cvc"

                mylog("Cred type", credential["type"])

                if (credential["type"] == "ukimmigration") {

                    // get the corresponding compiled Handlebars template
                    var template = getTemplate("ukimmigration")

                    // Generate the HTML using the credential
                    var html = template(credential["decoded"])

                    // Set the generated HTML into the page element
                    thisPage.querySelector('#placeHolder').innerHTML = html;

                    return;

                }

                if (credential["type"] == "w3cvc") {

                    let jwt = credential["encoded"]

                    // Perform some local checks before sending to server
                    let failedmsg = decodeJWT(jwt).error
                    if (failedmsg && failedmsg != "Expired certificate") {
                        showError(failedmsg)
                        window.history.back()
                        return;
                    }

                    if (screenType == ST_VERIFIER_SCAN) {

                        // Verify with the server if local verifications were successful
                        if (!failedmsg) {
                            // Verify the jwt including the signature (queries Issuer signature in the blockchain)
                            try {
                                let claims = await verifyJwtVc(jwt);
                                mylog("Credential verified by server", claims)
                            } catch (error) {
                                failedmsg = error.responseText
                                myerror("Credential verification failed", failedmsg)
                            }
                        }

                        // Display message depending on the result of verification
                        if (failedmsg) {
                            thisPage.querySelector("#alertCredentialFailed").style.display = "";
                            thisPage.querySelector("#failedmsg").innerHTML = failedmsg
                        } else {
                            // Sound the beep to indicate success
                            thisPage.querySelector("#alertCredentialSuccess audio").play()
                            thisPage.querySelector("#alertCredentialSuccess").style.display = "";
                            thisPage.querySelector("#placeHolder").classList.add("verified")
                        }

                    }

                    // Display background 
                    if (failedmsg) {
                        thisPage.querySelector("#placeHolder").classList.add("failed")
                    }


                    var schema = credential["decoded"]['body']['vc']['credentialSchema']['id']

                    console.log(schema)

                    // get the corresponding compiled Handlebars template
                    var template = getTemplate(schema)

                    // Generate the HTML using the "body" field of the credential
                    var html = template(credential["decoded"]["body"])

                    // Set the generated HTML into the page element
                    thisPage.querySelector('#placeHolder').innerHTML = html;

                }

            }

        </script>

        <script>

            function qrCredential() {
                pageData = window.history.state.pageData
                gotoPage("#passengerDisplayQR", { pageData })
            }


            async function saveCredential() {
                var currentCredential = await settingsGet("currentCredential")
                cred = await credentialsSave(currentCredential)

                // Reload app if credential was saved.
                // In case of error, do nothing (a modal screen is displayed)
                if (cred) {
                    // Reload application
                    console.log("Reloading the page to", homePage)
                    window.location.href = MYSELF
//                    window.location.reload()
                } else {
                    gotoPage(homePage)
                }
            }

            async function confirmDelete() {
                $('#passengerDeleteCredModal').modal("show")
                return;
            }

            async function deleteCredential() {
                $('#passengerDeleteCredModal').modal("hide")

                var currentCredential = await settingsGet("currentCredential")
                mylog("Deleting credential", currentCredential)
                await credentialsDeleteCred(currentCredential)
                await settingsDelete("currentCredential")

                gotoPage("#passengerCredList")
            }


            async function showError(_text) {
                myerror(_text)
                document.querySelector("#errorDisplayText").innerHTML = `${_text}`
                $('#errorDisplayModal').modal("show")
                return;
            }


            async function dismissError() {
                $('#errorDisplayModal').modal("hide")

                gotoPage(homePage)
            }

        </script>



        <!-- ============================================================================
        CREDENTIAL DETAILS PAGE

        Displays details about a given credential
        ============================================================================ -->

        <script>
            pages["#credentialDetailsPage"] = async function (pageData) {
                mylog("=> Inside #credentialDetailsPage")
                // Set the arrow back on the header
                headerBrandBack(true)
                var thisPage = document.querySelector("#credentialDetailsPage")
                await credentialDetailsPage(thisPage, pageData);
            }
        </script>

        <div id="credentialDetailsPage" class="jrmpage container">

            <!-- Error display in case of errors. Hidden initially -->
            <div id="credentialDetailsPageError" class="card shadow" style="display: none">
                <div class="card-body">
                    <h5 class="card-title">Error</h5>
                    <p class="card-text"></p>
                    <a onclick="history.back()" class="btn btn-primary">Back</a>
                </div>
            </div>

            <!-- *********************************************************************** -->
            <!-- This the placeholder where the credential will be displayed dynamically -->
            <div id="credentialDetailsPlaceHolder" class="container"></div>
            <!-- *********************************************************************** -->

        </div><!-- /page -->

        <script>
            function prettyJSON(json) {
                if (typeof json != 'string') {
                    json = JSON.stringify(json, undefined, 2);
                }
                json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
                    var cls = 'number';
                    if (/^"/.test(match)) {
                        if (/:$/.test(match)) {
                            cls = 'key';
                        } else {
                            cls = 'string';
                        }
                    } else if (/true|false/.test(match)) {
                        cls = 'boolean';
                    } else if (/null/.test(match)) {
                        cls = 'null';
                    }
                    return '<span class="' + cls + '">' + match + '</span>';
                });
            }

            async function credentialDetailsPage(thisPage, pageData) {

                // Hide the error display
                let errorEl = thisPage.querySelector("#credentialDetailsPageError")
                errorEl.style.display = "none"

                // Get the placeholder and erase its contents
                let el = document.querySelector("#credentialDetailsPlaceHolder")
                el.innerHTML = ""

                // Get the credential that the caller put in temporary storage
                let credential = await settingsGet("currentCredential")
                if (!credential) {
                    showError("Credential not in temporary storage")
                    window.history.back()
                    return;
                }
                mylog("Presenting credential", credential)

                // Get the type of credential
                let credType = credential["type"]
                mylog("Cred type", credType)

                if (credType == "w3cvc") {

                    // Extract the encoded JWT
                    let jwt = credential["encoded"]

                    // Perform some local checks before sending to server
                    let claims = decodeJWT(jwt)
                    if (claims.error && claims.error != "Expired certificate") {
                        // For any error except expiration, show an error and return
                        showError(claims.error)
//                        errorEl.style.display = ""
                        window.history.back()
                        return;
                    }

                    let theText = ""

                    // Display the title of the page
                    el.innerHTML += `<h3>Technical details</h3>`

                    // Display warning message only if expired
                    if (claims.error) {
                        el.innerHTML += `<p>The credential is expired so it can not be verified with the server. 
However some technical information about the credential follows.</p>`
                    }

                    // Display the credential
                    el.innerHTML += `<h4>About the credential</h4>`

                    // Header of the credential
                    theText = prettyJSON(claims.header)
                    el.innerHTML += `<p style="margin-bottom: 0"><strong>Header:</strong></p>
                    <pre>${theText}</pre>`

                    // Body body of the credential
                    theText = prettyJSON(claims.body)
                    el.innerHTML += `<p style="margin-bottom: 0"><strong>Body:</strong></p>
                    <pre>${theText}</pre>`
                    
                    // Do not continue if the credential is expired
                    if (claims.error) {
                        return;
                    }

                    // If we reached here, the local verifications were successful
                    // Verify with the server if local verifications were successful

                    // Verify the jwt including the signature (queries Issuer signature in the blockchain)
                    try {
                        claims = await verifyJwtVc(jwt);
                        console.log("DID Doc", claims.diddoc)
                        mylog("Credential verified by server", claims)
                    } catch (error) {
                        failedmsg = error.responseText
                        showError("Credential verification failed" + failedmsg)
                        window.history.back()
                        return;
                    }

                    // Display the DID Document
                    el.innerHTML += `<h4>DID Document of Issuer</h4>`

                    theText = prettyJSON(claims.diddoc)
                    el.innerHTML += `<pre>${theText}</pre>`
                 
                }
            }
        </script>


        <!-- =========================================== -->
        <!-- VERIFIER HOME PAGE -->
        <!-- =========================================== -->
        <script>
            pages["#verifierScanQR"] = async function () {
                console.log("=> Inside #verifierScanQR")
                console.log(window.history.state)
                qrHolder = document.querySelector("#verifierScanQR #qrCanvas")
                qrMessage = document.querySelector("#verifierScanQR #qrMessage")
                initiateReceiveQRScanning(qrHolder, qrMessage, "#displayCredentialPage", ST_VERIFIER_SCAN);
            }
        </script>

        <div id="verifierScanQR" class="jrmpage container">

            <div class="container">
                <h5 class="card-title">Point to QR</h5>
            </div>

            <div class="container">
                <canvas class="qrcanvas" id="qrCanvas" style="width: 100%;" hidden></canvas>
            </div>

            <div class="container">
                <div id="qrMessage">Waiting for QR ...</div>
            </div>

            <nav class="navbar fixed-bottom navbar-light bg-transparent">
                <button class="btn btn-lg btn-primary" onclick="history.back();">Cancel</button>
            </nav>

        </div><!-- /page -->


        <!-- =========================================== -->
        <!-- FAKE ISSUER HOME PAGE                            -->
        <!-- =========================================== -->
        <script>
            pages["#issuerHome"] = async function (pageData) {
                console.log("=> Inside #issuerHome")
                // Populate the credential list in the page
                var element = document.querySelector('#issuerHome #issuer_cred_list')
                fillIssuerCredList(element);
            }
        </script>

        <div id="issuerHome" class="jrmpage container">

            <div id="issuer_cred_list"></div>

        </div><!-- /page -->

        <script>

            function fillIssuerCredList(element) {

                // Retrieve the list of credentials from the fake issuer server
                // The server must be the same one used by the verifier application
                var targetURL = FAKE_ISSUER_GET_CREDENTIALS
                console.log(targetURL)
                $.get(targetURL, function (data) {
                    console.log(data);
                    // Fill the DOM of the verifier page with the received HTML
                    // First remove all child elements
                    $("#issuer_cred_list").empty();

                    creds = data.payload;

                    creds.forEach(get_issuer_cred_list);
                });
            }

            function get_issuer_cred_list(credential, index, array) {

                console.log(credential)
                var credentialDecoded = decodeJWT(credential["cert"])
                var schema = credentialDecoded['body']['vc']['credentialSchema']['id']

                var displayName = ""
                var subjectName = ""
                var cred_date = ""
                var analysisDate = ""
                var warning = ""
                var error_message = ""

                if (credentialDecoded.error) {
                    warning = "failed"
                }

                if (schema == "covidTestResult") {
                    displayName = "Covid19 certificate"
                    cred = credentialDecoded['body']['vc']['credentialSubject']['covidTestResult'];
                    analysisDate = cred['analysis']['date']
                    cred_date = formatDate(analysisDate * 1000)
                    subjectName = cred['patient']['name']
                }

                if (schema == "vaccinationCredential") {
                    displayName = "Vaccination certificate"
                    cred = credentialDecoded['body']['vc']['credentialSubject']['vaccinationCredential'];
                    analysisDate = cred['vaccination']['date']
                    cred_date = formatDate(analysisDate * 1000)
                    subjectName = cred['patient']['name']
                }

                if (schema == "publicCredential") {
                    cred = credentialDecoded['body']['vc']['credentialSubject']['publicCredential'];
                    cred_date = "The date"
                    displayName = cred['name']
                    subjectName = cred['entity']['name']
                }


                $("#issuer_cred_list").append(`
      <div class="card my-3 shadow ${warning}">

        <a onclick="transferViaQR('${credential["cert"]}')">
          <div class="card-body">
            <h5 class="card-title">${subjectName}</h5>
            <p>${displayName}</p>
            <p>${cred_date}</p>
          </div>
        </a>

      </div>`);

            }

        </script>


        <!-- =========================================== -->
        <!-- PUBCREDS ISSUER PAGE                            -->
        <!-- =========================================== -->
        <script>
            pages["#pubcreds"] = async function (pageData) {
                console.log("=> Inside #pubcreds")
                // Populate the credential list in the page
                var element = document.querySelector('#pubcreds #pub_cred_list')
                fillPubCredList(element);
            }
        </script>

        <div id="pubcreds" class="jrmpage container">

            <div id="pub_cred_list"></div>

        </div><!-- /page -->

        <script>

            function fillPubCredList(element) {

                // Retrieve the list of credentials from the fake issuer server
                // The server must be the same one used by the verifier application
                var targetURL = FAKE_ISSUER_GET_PUBLIC_CREDENTIALS
                console.log(targetURL)
                $.get(targetURL, function (data) {
                    console.log(data);
                    // Fill the DOM of the verifier page with the received HTML
                    // First remove all child elements
                    $("#pub_cred_list").empty();

                    creds = data.payload;
                    let innerHTML = `<div class="row">`

                    for (let i=0; i < creds.length; i++) {
                        let credential = creds[i]

                        console.log(credential)
                        var credentialDecoded = decodeJWT(credential["cert"])
                        var schema = credentialDecoded['body']['vc']['credentialSchema']['id']

                        console.log(schema)

                        var displayName = ""
                        var cred_date = ""
                        var analysisDate = ""
                        var warning = ""
                        var error_message = ""
                        var subjectName = ""

                        if (credentialDecoded.error) {
                            warning = "failed"
                        }

                        if (schema == "covidTestResult") {
                            displayName = "Covid19 certificate"
                            cred = credentialDecoded['body']['vc']['credentialSubject']['covidTestResult'];
                            analysisDate = cred['analysis']['date']
                            cred_date = formatDate(analysisDate * 1000)
                            subjectName = cred['patient']['name']
                        }

                        if (schema == "vaccinationCredential") {
                            displayName = "Vaccination certificate"
                            cred = credentialDecoded['body']['vc']['credentialSubject']['vaccinationCredential'];
                            analysisDate = cred['vaccination']['date']
                            cred_date = formatDate(analysisDate * 1000)
                            subjectName = cred['patient']['name']
                        }

                        if (schema == "publicCredential") {
                            cred = credentialDecoded['body']['vc']['credentialSubject']['publicCredential'];
                            cred_date = formatDate(credentialDecoded['body']['iat'] * 1000)
                            displayName = cred['name']
                            subjectName = cred['entity']['name']
                        }

                        innerHTML += `
                            <div class="col-sm-6">
                                <div class="card my-3 shadow ${warning}">
                                    <a onclick="transferViaQR('${credential["cert"]}')">
                                        <div class="card-body">
                                            <h5 class="card-title">${subjectName}</h5>
                                            <p>${displayName}</p>
                                            <p>${cred_date}</p>
                                        </div>
                                    </a>
                                </div>
                            </div>`
                    }
                    innerHTML += `</div>`
                    element.innerHTML = innerHTML

//                    creds.forEach(get_pub_cred_list);
                });
            }

            function get_pub_cred_list(credential, index, array) {

                console.log(credential)
                var credentialDecoded = decodeJWT(credential["cert"])
                var schema = credentialDecoded['body']['vc']['credentialSchema']['id']

                console.log(schema)

                var displayName = ""
                var cred_date = ""
                var analysisDate = ""
                var warning = ""
                var error_message = ""
                var subjectName = ""

                if (credentialDecoded.error) {
                    warning = "failed"
                }

                if (schema == "covidTestResult") {
                    displayName = "Covid19 certificate"
                    cred = credentialDecoded['body']['vc']['credentialSubject']['covidTestResult'];
                    analysisDate = cred['analysis']['date']
                    cred_date = formatDate(analysisDate * 1000)
                    subjectName = cred['patient']['name']
                }

                if (schema == "vaccinationCredential") {
                    displayName = "Vaccination certificate"
                    cred = credentialDecoded['body']['vc']['credentialSubject']['vaccinationCredential'];
                    analysisDate = cred['vaccination']['date']
                    cred_date = formatDate(analysisDate * 1000)
                    subjectName = cred['patient']['name']
                }

                if (schema == "publicCredential") {
                    cred = credentialDecoded['body']['vc']['credentialSubject']['publicCredential'];
                    cred_date = formatDate(credentialDecoded['body']['iat'] * 1000)
                    displayName = cred['name']
                    subjectName = cred['entity']['name']
                }


                $("#pub_cred_list").append(`
    <div class="col-sm-5">
      <div class="card my-3 shadow ${warning}">

        <a onclick="transferViaQR('${credential["cert"]}')">
          <div class="card-body">
            <h5 class="card-title">${subjectName}</h5>
            <p>${displayName}</p>
            <p>${cred_date}</p>
          </div>
        </a>
    </div>

      </div>`);

            }

        </script>


        <!-- =========================================== -->
        <!-- DELETE CREDENTIAL MODAL -->
        <!-- =========================================== -->

        <div class="modal" id="passengerDeleteCredModal" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Are you sure?</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <p>Confirm that you want to delete this credential.</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary btn-lg" data-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-danger btn-lg" onclick="deleteCredential()">Delete</button>
                    </div>
                </div>
            </div>
        </div>


        <!-- =========================================== -->
        <!-- ERROR DISPLAY MODAL                         -->
        <!-- =========================================== -->

        <div class="modal" id="errorDisplayModal" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">There was an error</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div id="errorDisplayText"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary btn-lg" data-dismiss="modal">Cancel</button>
                    </div>
                </div>
            </div>
        </div>




        <!-- =========================================== -->
        <!-- PASSENGER QR SCANNING PAGE -->
        <!-- =========================================== -->
        <script>
            pages["#passengerQRScan"] = async function (pageData) {
                console.log("=> Inside #passengerQRScan")
                console.log(window.history.state)
                qrHolder = document.querySelector("#passengerQRScan #qrCanvas")
                qrMessage = document.querySelector("#passengerQRScan #qrMessage")
                initiateReceiveQRScanning(qrHolder, qrMessage, "#displayCredentialPage", ST_PASSENGER_SCAN);
            }
        </script>

        <div id="passengerQRScan" class="jrmpage container">

            <div class="container">
                <h5 class="card-title">Point to QR from Issuer</h5>
            </div>

            <div class="container">
                <canvas class="qrcanvas" id="qrCanvas" style="width: 100%;" hidden></canvas>
            </div>

            <div class="container">
                <div id="qrMessage">Waiting for QR ...</div>
            </div>


            <nav class="navbar fixed-bottom navbar-light bg-transparent">
                <a class="btn btn-lg btn-primary" onclick="history.back();">Cancel</a>
            </nav>

        </div><!-- /page -->




        <!-- =========================================== -->
        <!-- PASSENGER DISPLAY QR                        -->
        <!-- =========================================== -->
        <script>
            pages["#passengerDisplayQR"] = async function (pageData) {
                console.log("=> Inside #passengerDisplayQR");

                headerBrandBack(true)
                var thisPage = document.querySelector("#passengerDisplayQR")
                var currentCredential = await settingsGet("currentCredential")
                passengerDisplayQR(thisPage, currentCredential);

            }
        </script>

        <div id="passengerDisplayQR" class="jrmpage container">

            <img id="realplaceholderQR" src="">

            <div id="passengerDisplayQRMessage"></div>

            <nav class="navbar fixed-bottom navbar-light bg-transparent">
                <a class="btn btn-lg btn-primary" onclick="history.back();">Cancel</a>
            </nav>

            <div id="offPlaceholderQR"></div>

        </div><!-- /page -->



        <!-- =========================================== -->
        <!-- =========================================== -->
        <!-- =========================================== -->
        <!-- =========================================== -->


        <!-- =========================================== -->
        <!-- ADMIN PAGE                                  -->
        <!-- =========================================== -->
        <script>
            pages["#admin"] = async function (pageData) {
                // Add any initialization code here
            }
        </script>

        <div id="admin" class="jrmpage container">

            <div class="alert alert-danger" role="alert">
                <p><strong>Warning! </strong>Use these functions only if you know the implications or if instructed by
                    operations personnel.</p>
            </div>

            <div class="card my-3 shadow">
                <a onclick="gotoPage('#logsPage')">
                    <div class="card-body">
                        <h4 class="card-title">Display logs</h4>
                    </div>
                </a>
            </div>

            <div class="card mb-3 shadow">
                <a onclick="gotoPage('#diagnosticsPage')">
                    <div class="card-body">
                        <h4 class="card-title">Run diagnostics</h4>
                    </div>
                </a>
            </div>

            <div class="card mb-3 shadow">
                <a onclick="clearLogs()">
                    <div class="card-body">
                        <h4 class="card-title">Clear logs</h4>
                    </div>
                </a>
            </div>

            <div class="card mb-3 shadow">
                <a onclick="resetDatabase()">
                    <div class="card-body">
                        <h4 class="card-title">Reset application</h4>
                    </div>
                </a>
            </div>

        </div><!-- /page -->

        <script>
            // Clears the logs table, preserving the other tables
            async function clearLogs() {
                await db.logs.clear()
                alert("Logs cleared")
                // Reload application in the same page
                location.reload()
            }

            // Erases completely the database including credentials.
            async function resetDatabase() {
                // Delete database, erasing all tables and their contents
                await db.delete()
                alert("Database erased")

                // Reload application in the same page
                location.reload()
            }
        </script>

        <!-- =========================================== -->
        <!-- DISPLAY LOGS                                -->
        <!-- =========================================== -->
        <script>
            pages["#logsPage"] = async function (pageData) {
                console.log("=> Inside #logsPage")
                // Populate the credential list in the page
                var element = document.querySelector('#logsPage .placeHolder')
                await fillLogs(element);
            }
        </script>

        <div id="logsPage" class="jrmpage container">

            <div class="container">
                <div class="placeHolder"></div>
            </div>

        </div><!-- /page -->

        <script>

            async function fillLogs(placeHolder) {

                var recentLogs = await db.logs.reverse().limit(200).toArray()

                var h = ""
                for (let i = 0; i < recentLogs.length; i++) {
                    let format = "logging"
                    if (recentLogs[i].level == "E") {
                        format = "loggingError"
                    }
                    let ts = new Date(recentLogs[i].timestamp);
                    let month = ts.getMonth() + 1
                    month = month.toString().padStart(2,"0")
                    let day = ts.getDate().toString().padStart(2,"0")
                    let hours = ts.getHours().toString().padStart(2,"0")
                    let minutes = ts.getMinutes().toString().padStart(2,"0")
                    let seconds = ts.getSeconds().toString().padStart(2,"0")

                    timestamp = month + day + "-" + hours + minutes + seconds
                    let desc = recentLogs[i].desc
                    let item = recentLogs[i].item

                    h = h + `<p class="${format}">${timestamp} ${desc} ${item}</p>`
                }

                placeHolder.innerHTML = h;

            }

        </script>

        <!-- =========================================== -->
        <!-- DIAGNOSTICS                                 -->
        <!-- =========================================== -->
        <script>
            pages["#diagnosticsPage"] = async function (pageData) {
                console.log("=> Inside #diagnosticsPage")
                // Populate the credential list in the page
                var element = document.querySelector('#diagnosticsPage .placeHolder')
                await fillDiagnostics(element);
            }
        </script>

        <div id="diagnosticsPage" class="jrmpage container">

            <div class="placeHolder"></div>

        </div><!-- /page -->

        <script>

            async function fillDiagnostics(h) {

                // Database
                h.innerHTML += `<p style="margin-bottom: 0">DB version: ${db.verno}</p>`
                let dbnames = await Dexie.getDatabaseNames()
                h.innerHTML += `<p style="margin-bottom: 0">DB names: ${dbnames}</p>`
                // Output the schema of each table:
                db.tables.forEach(function (table) {
                    h.innerHTML += `<p style="margin-bottom: 0">Schema of ${table.name}:</p><pre>${JSON.stringify(table.schema, null, "  ")}</pre>`
                });

                // Dimensions of the screen
                h.innerHTML += `<p style="margin-bottom: 0">Screen width: ${screen.width}</p>`
                h.innerHTML += `<p style="margin-bottom: 0">Screen height: ${screen.height}</p>`
                h.innerHTML += `<p style="margin-bottom: 0">Screen availWidth: ${screen.availWidth}</p>`
                h.innerHTML += `<p style="margin-bottom: 0">Screen availHeight: ${screen.availHeight}</p>`

                el = document.querySelector('html')
                h.innerHTML += `<p style="margin-bottom: 0">Html offsetHeight: ${el.offsetHeight}</p>`
                h.innerHTML += `<p style="margin-bottom: 0">Html offsetWidth: ${el.offsetWidth}</p>`
                h.innerHTML += `<p style="margin-bottom: 0">Html clientHeight: ${el.clientHeight}</p>`
                h.innerHTML += `<p style="margin-bottom: 0">Html clientWidth: ${el.clientWidth}</p>`

                el = document.querySelector('body')
                h.innerHTML += `<p style="margin-bottom: 0">Body offsetHeight: ${el.offsetHeight}</p>`
                h.innerHTML += `<p style="margin-bottom: 0">Body offsetWidth: ${el.offsetWidth}</p>`
                h.innerHTML += `<p style="margin-bottom: 0">Body clientHeight: ${el.clientHeight}</p>`
                h.innerHTML += `<p style="margin-bottom: 0">Body clientWidth: ${el.clientWidth}</p>`

                el = document.querySelector('#header')
                h.innerHTML += `<p style="margin-bottom: 0">Header offsetHeight: ${el.offsetHeight}</p>`
                h.innerHTML += `<p style="margin-bottom: 0">Header offsetWidth: ${el.offsetWidth}</p>`
                h.innerHTML += `<p style="margin-bottom: 0">Header clientHeight: ${el.clientHeight}</p>`
                h.innerHTML += `<p style="margin-bottom: 0">Header clientWidth: ${el.clientWidth}</p>`

                h.innerHTML += `<h1>Example text</h1>`
                h.innerHTML += `<h2>Example text</h2>`
                h.innerHTML += `<h3>Example text</h3>`
                h.innerHTML += `<h4>Example text</h4>`
                h.innerHTML += `<h5>Example text</h5>`


            }


        </script>


        <!-- =========================================== -->
        <!-- =========================================== -->
        <!-- =========================================== -->
        <!-- =========================================== -->


        <!-- =========================================== -->
        <!-- TEMPLATES FOR CREDENTIALS                   -->
        <!-- =========================================== -->

        <!-- Template management -->
        <script src="js/handlebars.js"></script>

        <script>
            // The list of credential templates supported
            var credentialTemplatesName = [
                "covidTestResult",
                "vaccinationCredential",
                "publicCredential",
                "ukimmigration"
            ]


            Handlebars.registerHelper('toUTCDate', function (dateStamp) {
                var cred_date = new Date(dateStamp * 1000);
                return cred_date.toUTCString()
            })

            Handlebars.registerHelper('toDate', function (dateStamp) {
                var d = new Date(dateStamp * 1000);
                var year = d.getFullYear()
                var month = d.getMonth() + 1
                month = month.toString().padStart(2,"0")
                var day = d.getDate().toString().padStart(2,"0")
                var hours = d.getHours().toString().padStart(2,"0")
                var minutes = d.getMinutes().toString().padStart(2,"0")
                var seconds = d.getSeconds().toString().padStart(2,"0")

                return year + "-" + month + "-" + day + "T" + hours + ":" + minutes + ":" + seconds
            })



            var credentialTemplatesCompiled = []

            function compileCredentialTemplates() {

                for (i = 0; i < credentialTemplatesName.length; i++) {
                    var templateName = credentialTemplatesName[i];
                    var templateSource = document.getElementById(templateName).innerHTML;
                    var compiledTemplate = Handlebars.compile(templateSource);

                    credentialTemplatesCompiled.push(compiledTemplate);
                }

            }

            function getTemplate(name) {
                mylog("template name", name)
                index = credentialTemplatesName.indexOf(name);
                if (index == -1) { return undefined }
                return credentialTemplatesCompiled[index];
            }

        </script>





<script class="credentialTemplate" id="publicCredential" type="text/x-handlebars-template">

    {{#with vc.credentialSubject.publicCredential}}


    <div class="card my-3 shadow">

            <div class="flex d-flex align-items-center" style="height: 120px;">
                <img id="pubcredLogo" src="{{entity.logo}}" class="float-left" style="height: 120px;">
            </div>

        <div class="card-body">
            <h5 class="card-title">{{entity.name}}</h5>
            <h5 class="card-title">{{name}}</h5>
        </div>

        <ul>
            {{#each self_declarations}}
            <li>{{this}}</li>
            {{/each}}
        </ul>

    {{/with}}

        <div class="card-body">
            <p><strong>Issued: {{toDate iat}}</strong></p>
            <p><strong>Expires: {{toDate exp}}</strong></p>
            <a href="{{vc.credentialSubject.publicCredential.entity.url}}" class="card-link">Go to website</a>
        </div>

    </div>
  
  </script>
  


        <script class="credentialTemplate" id="covidTestResult" type="text/x-handlebars-template">

  {{#with vc.credentialSubject.covidTestResult}}
  <div class="container">

    <!-- The content of the container is a template of a credential, filled with
        sample data. The individual fields inside the template are modified by the 
        functions receiving and retrieving actual credential data (in JSON format) -->

    <div class="row">
      <div class="col">
        <div class="row">
          <p class="etiqueta">Name</p>
        </div>
        <div class="row">
          <p class="valor text-break" id="name">{{patient.name}}</p>
        </div>
      </div>
    </div>


    <div class="row">
      <div class="col">
        <div class="row">
          <p class="etiqueta">Date of birth</p>
        </div>
        <div class="row">
          <p class="valor" id="dob">{{patient.dob}}</p>
        </div>
      </div>
      <div class="col">
        <div class="row">
          <p class="etiqueta">Test number</p>
        </div>
        <div class="row">
          <p class="valor text-break" id="testnum">{{analysis.id}}</p>
        </div>
      </div>
    </div>
  
    <div class="row">
      <div class="col">
        <div class="row">
          <p class="etiqueta">Test type</p>
        </div>
        <div class="row">
          <p class="valor text-break" id="testtype">{{analysis.type}}</p>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col">
        <div class="row">
          <p class="etiqueta">Test date</p>
        </div>
        <div class="row">
          <p class="valor" id="testdate">{{toDate analysis.date}}</p>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col">
        <div class="row">
          <p class="etiqueta">Lab name</p>
        </div>
        <div class="row">
          <p class="valor" id="labname">{{lab.name}}</p>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col">
        <div class="row">
          <p class="etiqueta">Lab address</p>
        </div>
        <div class="row">
          <p class="valor" id="labaddress">{{lab.address}}</p>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col">
        <div class="row">
          <p class="etiqueta">Lab phone</p>
        </div>
        <div class="row">
          <p class="valor" id="labphone">{{lab.phone}}</p>
        </div>
      </div>
    </div>
    
  </div>
  {{/with}}

</script>


        <script class="credentialTemplate" id="vaccinationCredential" type="text/x-handlebars-template">

  {{#with vc.credentialSubject.vaccinationCredential}}
  <div class="container">

    <!-- The content of the container is a template of a credential, filled with
        sample data. The individual fields inside the template are modified by the 
        functions receiving and retrieving actual credential data (in JSON format) -->

    <!-- PERSON IDENTIFICATION CARD -->

    <div class="row">
      <div class="col">
        <div class="row">
          <p class="etiqueta">Name:</p>
        </div>
        <div class="row">
          <p class="valor">{{patient.name}}</p>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col">
        <div class="row">
          <p class="etiqueta">ID:</p>
        </div>
        <div class="row">
          <p class="valor">{{patient.idnumber}}</p>
        </div>
      </div>
      <div class="col">
        <div class="row">
          <p class="etiqueta">Birth date</p>
        </div>
        <div class="row">
          <p class="valor">{{patient.dob}}</p>
        </div>
      </div>
    </div>

    <!-- VACCINATION CARD -->

    <div class="row">
      <div class="col">
        <div class="row">
          <p class="etiqueta">Disease target:</p>
        </div>
        <div class="row">
          <p class="valor">{{vaccination.disease}}</p>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col">
        <div class="row">
          <p class="etiqueta">Vaccine:</p>
        </div>
        <div class="row">
          <p class="valor">{{vaccination.vaccine}}</p>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col">
        <div class="row">
          <p class="etiqueta">Product:</p>
        </div>
        <div class="row">
          <p class="valor">{{vaccination.product}}</p>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col">
        <div class="row">
          <p class="etiqueta">Auth holder:</p>
        </div>
        <div class="row">
          <p class="valor">{{vaccination.auth_holder}}</p>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col">
        <div class="row">
          <p class="etiqueta">Dose:</p>
        </div>
      </div>
      <div class="col">
        <div class="row">
          <p class="valor">{{vaccination.dose_number}}</p>
        </div>
      </div>
      <div class="col">
        <div class="row">
          <p class="etiqueta">of:</p>
        </div>
      </div>
      <div class="col">
        <div class="row">
          <p class="valor">{{vaccination.total_doses}}</p>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col">
        <div class="row">
          <p class="etiqueta">Batch:</p>
        </div>
        <div class="row">
          <p class="valor">{{vaccination.batch}}</p>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col">
        <div class="row">
          <p class="etiqueta">Date:</p>
        </div>
        <div class="row">
          <p class="valor">{{toDate vaccination.date}}</p>
        </div>
      </div>
      <div class="col">
        <div class="row">
          <p class="etiqueta">Next date:</p>
        </div>
        <div class="row">
          <p class="valor">{{toDate vaccination.next_date}}</p>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col">
        <div class="row">
          <p class="etiqueta">Center:</p>
        </div>
        <div class="row">
          <p class="valor">{{vaccination.center}}</p>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col">
        <div class="row">
          <p class="etiqueta">Health professional:</p>
        </div>
        <div class="row">
          <p class="valor">{{vaccination.professional}}</p>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col">
        <div class="row">
          <p class="etiqueta">Country:</p>
        </div>
        <div class="row">
          <p class="valor">{{vaccination.country}}</p>
        </div>
      </div>
    </div>


  </div>
  {{/with}}

</script>


        <script class="credentialTemplate" id="ukimmigration" type="text/x-handlebars-template">

  <div class="container">

      <!-- The content of the container is a template of a credential, filled with
          sample data. The individual fields inside the template are modified by the 
          functions receiving and retrieving actual credential data (in JSON format) -->

      <!-- PERSON IDENTIFICATION CARD -->
      <div class="card mb-3">
          <header class="card-header">
              <p class="card-header-title">
                  UK Visas & Immigration
              </p>
          </header>
          <div class="card-content">
              <div class="content">


                      <p>Name: <b>{{ln}}/{{fn}}</b></p>
                      <p>Passport: <b>{{di}}</b></p>
                      <p>Date: <b>{{ts}}</b></p>
                      <p>Reference: <b>{{rf}}</b></p>
                      
                      {{#each tg}}
                      <p>Phone: <b>+{{this.code}} {{this.number}}</b></p>

                      {{/each}}

                      <p>Address: <b>{{qa}}</b></p>



              </div>
          </div>
      </div>


  </div>

</script>


        <!-- ================================ -->
        <!-- END TEMPLATES FOR CREDENTIALS    -->
        <!-- ================================ -->



        <!-- ================================ -->
        <!-- APPLICATION SCRIPTS              -->
        <!-- ================================ -->

        <!-- Database layer on top of IndexedDB -->
        <script src="js/dexie.js"></script>

        <!-- JQuery -->
        <script src="js/jquery-3.5.1.min.js"></script>

        <!-- Bootstrap 4 -->
        <!-- <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-Piv4xVNRyMGpqkS2by6br4gNJ7DXjqk09RmUpJ8jgGtD7zP9yug3goQfGII0yAns"
            crossorigin="anonymous"></script> -->
        <script src="js/bootstrap.bundle.min.js"></script>
        
        <script src="js/base45-js.js"></script>
        <script src="js/pako.js"></script>
        <script src="js/cose.js"></script>

        <!-- Scan a QR -->
        <script src="js/jsQR.js"></script>

        <!-- Generate a QR -->
        <script src="js/easy.qrcode.min.js"></script>

        <!-- The Application logic -->
        <script src="js/apponsen.js"></script>

    </div>
</body>

</html>