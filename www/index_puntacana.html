<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta
      name="description"
      content="Verifiable Credentials for a Safe Island"
    />
    <title>Safe Island</title>

    <!-- <script type="module" src="./components/navbar.js"></script> -->

    <!-- Bootstrap 4 CSS -->
    <link rel="stylesheet" href="css/bootstrap.min.css" />

    <!-- Bootstrap 4 Icons -->
    <link rel="stylesheet" href="css/bootstrap-icons.css" />

    <!-- Specific CSS for this project -->
    <link rel="stylesheet" href="css/safeisland.css" />

    <!-- <link rel="manifest" href="/manifest.json"> -->

    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <meta name="apple-mobile-web-app-title" content="SafeIsland" />
    <link rel="apple-touch-icon" href="img/icon-152.png" />
  </head>

  <body>
      <script>
          var pages = {};
      </script>

    <!-- Use a container to manage margins at different responsive sizes -->
    <div class="containerjrm">



      <nav-bar id="header" class="navbar navbar-light bg-light shadow">
      <!-- We use two headers, displayed/hidden depending on the specific page -->
      <!-- The first header is displayed by default and is used for main pages -->
      <div id="headerBrandNormal">
        <a class="navbar-brand" onclick="gotoPage(homePage)">

            <img src="punta_cana.png" height="35px" alt="Logo" />

          <span style="padding-left: 20px;">SafeIsland</span>
          <button
            id="butInstall"
            class="btn btn-sm btn-primary"
            style="display: none"
            type="button"
          >
            Install
          </button>
        </a>
      </div>

      <!-- The second header is for pages with a back arrow -->
      <div id="headerBrandBack" style="display: none">
        <a class="navbar-brand" onclick="history.back()">
          <i class="bi bi-arrow-left"></i>
          <span>Back</span>
        </a>
      </div>

      </nav-bar>

      <!-- =========================================== -->
      <!-- PASSENGER CREDENTIAL LIST PAGE              -->
      <!-- =========================================== -->
      <div id="credentialListPage" class="jrmpage container">
        <!-- This is a placeholder for the list of credentials -->
        <div id="credentialListHolder"></div>

        <!-- The FAB button to scan a new credential -->
        <div
          class="fab bg-primary"
          onclick='gotoPage("#passengerQRScanPage", { caller: "credentialListPage" })'
        >
          <i class="bi bi-plus"></i>
        </div>
      </div>
      <!-- /page -->

      <!-- ============================================================================
        GENERIC CREDENTIAL DISPLAY PAGE

        Displays any type of credential and can be used from the Passenger, Verifier
        or Issuer screens.
        The buttons displayed on the footer depend on the caller.
        ============================================================================ -->
      <div id="displayCredentialPage" class="jrmpage container">
        <!-- Alert used only by Passenger: display message when new credential received.
                Display a button to save the credential to the local repository -->
        <div
          id="alertCredentialReceived"
          class="alert alert-success"
          style="display: none"
          role="alert"
        >
          <div class="row">
            <div class="col-8">
              You received a credential! Press Save to keep it.
            </div>
            <div class="col">
              <a id="saveCredentialButton" class="btn btn-primary">
                <i class="bi bi-download"></i>
                Save
              </a>
            </div>
          </div>
        </div>

        <!-- Alert used only by Verifier if verification failed -->
        <div
          id="alertCredentialFailed"
          class="alert alert-danger"
          style="display: none"
          role="alert"
        >
          <div class="row">
            <div class="col">
              <p>Verification failed</p>
              <p id="failedmsg"></p>
            </div>
          </div>
        </div>

        <!-- Alert used only by Verified if verification success -->
        <div
          id="alertCredentialSuccess"
          class="alert alert-success"
          style="display: none"
          role="alert"
        >
          <audio src="img/beep.mp3" style="display: none"></audio>

          <div class="row">
            <div class="col">Verification succeeded.</div>
          </div>
        </div>

        <!-- *********************************************************************** -->
        <!-- This the placeholder where the credential will be displayed dynamically -->
        <div id="placeHolder"></div>
        <!-- *********************************************************************** -->

        <!-- The container for the buttons in the footer -->
        <div class="container">
          <!-- The footer is fixed to the bottom. This spacer avoids main content to overlap -->
          <div class="myspacer" style="height: 75px"></div>

          <nav id="footer" class="navbar fixed-bottom navbar-light bg-light">
            <a
              id="backButton"
              class="btn btn-lg btn-primary shadow"
              style="display: none"
              onclick="history.back()"
            >
              <i class="bi bi-arrow-clockwise"></i>
              Scan again
            </a>
            <a
              id="displayQRButton"
              class="btn btn-primary shadow"
              style="display: none"
            >
              <i class="bi bi-upc-scan"></i>
              QR
            </a>
            <a
              id="shareButton"
              class="btn btn-primary shadow"
              style="display: none"
              onclick="gotoPage('#credentialDetailsPage');"
            >
              <i class="bi bi-zoom-in"></i>
              Details
            </a>
            <a
              id="deleteButton"
              class="btn btn-danger shadow"
              style="display: none"
            >
              <i class="bi bi-trash"></i>
              Delete
            </a>
          </nav>
        </div>
      </div>
      <!-- /page -->

      <!-- =========================================== -->
      <!-- PASSENGER DISPLAY QR                        -->
      <!-- =========================================== -->

      <div id="displayQRPage" class="jrmpage container">
        <img id="realplaceholderQR" src="" alt="QR" />

        <div id="displayQRPageMessage"></div>

        <nav class="navbar fixed-bottom navbar-light bg-transparent">
          <a class="btn btn-lg btn-primary" onclick="history.back();">Cancel</a>
        </nav>

        <div id="offPlaceholderQR"></div>
      </div>
      <!-- /page -->

      <!-- =========================================== -->
      <!-- PASSENGER QR SCANNING PAGE -->
      <!-- =========================================== -->
      <div id="passengerQRScanPage" class="jrmpage container">
        <h5 class="card-title">Point to QR from Issuer</h5>

        <canvas
          class="qrcanvas"
          id="passengerQRScanPageCanvas"
          style="width: 100%"
        ></canvas>

        <div id="passengerQRScanPageMessage">Waiting for QR ...</div>

        <nav class="navbar fixed-bottom navbar-light bg-transparent">
          <a class="btn btn-lg btn-primary" onclick="history.back();">Cancel</a>
        </nav>
      </div>
      <!-- /page -->

      <!-- =========================================== -->
      <!-- VERIFIER QR SCANNING PAGE -->
      <!-- =========================================== -->
      <div id="verifierScanQR" class="jrmpage container">
        <h5 class="card-title">Point to QR</h5>

        <canvas
          class="qrcanvas"
          id="qrCanvas"
          style="width: 100%"
          hidden
        ></canvas>

        <div id="qrMessage">Waiting for QR ...</div>

          
        <nav class="navbar fixed-bottom navbar-light bg-transparent">
          <button class="btn btn-lg btn-primary" onclick="history.back();">
            Cancel
          </button>
        </nav>
      </div>
      <!-- /page -->

      <!-- =========================================== -->
      <!-- HOME PAGE for demos. It has the three roles -->
      <!-- and the user can choose                     -->
      <!-- =========================================== -->
      <div id="demo" class="jrmpage container">
        <!-- The demo page has several cards acting as huge buttons of a menu -->
        <div class="card my-3 shadow">
          <a onclick="gotoPage('#credentialListPage')">
            <div class="card-body">
              <h4 class="card-title">I am a Passenger</h4>
              <p>Receive or show your test results</p>
            </div>
          </a>
        </div>

        <div class="card my-3 shadow">
          <a onclick="gotoPage('#verifierScanQR')">
            <div class="card-body">
              <h4 class="card-title">I am a Verifier</h4>
              <p>Review the test results of a passenger</p>
            </div>
          </a>
        </div>

        <div class="card my-3 shadow">
          <a onclick="gotoPage('#issuerHome')">
            <div class="card-body">
              <h4 class="card-title">I am an Issuer</h4>
              <p>Check my lab test results</p>
            </div>
          </a>
        </div>

        <div class="card my-3 shadow">
          <a onclick="gotoPage('#pubcreds')">
            <div class="card-body">
              <h4 class="card-title">Public Credentials</h4>
              <p>Query the public credentials</p>
            </div>
          </a>
        </div>

        <div class="card my-3 shadow">
          <a onclick="gotoPage('#tuboScanPage')">
            <div class="card-body">
              <h4 class="card-title">Test input</h4>
              <p>Enter data for a new test</p>
            </div>
          </a>
        </div>

        <div class="card my-3 shadow">
          <a onclick="gotoPage('#admin')">
            <div class="card-body">
              <h4 class="card-title">Admin</h4>
              <p>Only if you know what you are doing</p>
            </div>
          </a>
        </div>
      </div>
      <!-- /page -->

      <!-- =========================================== -->
      <!-- TUBO HOME PAGE -->
      <!-- =========================================== -->
      <div id="tuboScanPage" class="jrmpage container">
        <div
          id="alertNoTubeVideo"
          class="alert alert-danger alert-dismissible fade show"
          style="display: none"
          role="alert"
        >
          <strong>Camera not available.</strong> Please reload and allow access.
          <button
            type="button"
            class="close"
            data-dismiss="alert"
            aria-label="Close"
          >
            <span aria-hidden="true">&times;</span>
          </button>
        </div>

        <h5 class="card-title">Enter the test data</h5>

        <video id="tuboVideo" style="width: 100%; display: none"></video>
        <div class="camera" id="tuboDisplay" style="display: none">
          <canvas id="tuboCanvas" style="width: 100%"
            >Video stream not available.</canvas
          >
          <p>
            Point the camera to the test tube, or enter manually the code below.
          </p>
        </div>

        <form>
          <div class="input-group mb-2">
            <div class="input-group-prepend">
              <span class="input-group-text">Test code</span>
            </div>
            <input
              id="result"
              type="text"
              aria-label="Test code"
              class="form-control"
            />
          </div>
          <div class="input-group mb-2">
            <div class="input-group-prepend">
              <span class="input-group-text">First name</span>
            </div>
            <input type="text" aria-label="First name" class="form-control" />
          </div>
          <div class="input-group mb-2">
            <div class="input-group-prepend">
              <span class="input-group-text">Last name</span>
            </div>
            <input type="text" aria-label="Last name" class="form-control" />
          </div>
          <div class="input-group mb-2">
            <div class="input-group-prepend">
              <span class="input-group-text">Date of birth</span>
            </div>
            <input type="date" aria-label="DoB" class="form-control" />
          </div>
          <div class="input-group mb-2">
            <div class="input-group-prepend">
              <span class="input-group-text">@</span>
            </div>
            <input type="email" aria-label="Email" class="form-control" />
          </div>
        </form>

        <div>
          <button
            id="tuboScanButton"
            class="btn btn-lg btn-primary"
            style="display: none"
          >
            Scan again
          </button>
        </div>
      </div>
      <!-- /page -->

      <!-- =========================================== -->
      <!-- PUBCRED ENTRY for entities                   -->
      <!-- =========================================== -->
      <script>
        // Register the page function
        pages["#pubcredEntry"] = async function (pageData) {
          console.log("=> Inside pubcredEntry");
        };
      </script>

      <!-- Each page is a simple container with the special class jrmpage -->
      <!-- Page transitions are implemented in javascript hiding all except the one to show -->
      <div id="pubcredEntry" class="jrmpage container">
        <img
          id="logoPreview"
          src=""
          height="200"
          alt="Image preview"
          style="display: none"
          alt="logo"
        />

        <form class="row g-3">
          <div class="mb-3 col-md-12">
            <label for="logoFile" class="form-label">Logo file</label>
            <input
              type="file"
              accept=".jpg, .png"
              onchange="previewFile()"
              class="form-control"
              id="logoFile"
              aria-describedby="logoHelp"
            />
          </div>

          <div class="mb-3 col-md-12">
            <label for="name" class="form-label">Entity</label>
            <input type="text" class="form-control" id="name" />
          </div>

          <div class="mb-3 col-md-12">
            <label for="declName" class="form-label">Name of declaration</label>
            <input
              type="text"
              class="form-control"
              id="declName"
              placeholder="ESTABLECIMIENTO Covid Safe Responsable"
            />
          </div>

          <div class="mb-3 col-md-12">
            <hr />
            <p>Declarations</p>

            <div class="container">
              <div class="ms-3 form-check">
                <input
                  class="form-check-input"
                  type="checkbox"
                  value="decl1"
                  id="decl1"
                />
                <label class="form-check-label" for="decl1">
                  Cumple Protocolos Sanitarios
                </label>
              </div>

              <div class="ms-3 form-check">
                <input
                  class="form-check-input"
                  type="checkbox"
                  value="decl2"
                  id="decl2"
                />
                <label class="form-check-label" for="decl2">
                  Cumple Test PcR Q Empleados
                </label>
              </div>

              <div class="ms-3 form-check">
                <input
                  class="form-check-input"
                  type="checkbox"
                  value="decl3"
                  id="decl3"
                />
                <label class="form-check-label" for="decl3">
                  Cumple Protocolos PoC
                </label>
              </div>
            </div>

            <hr />
          </div>

          <div class="col-6 mb-3">
            <label for="issued" class="form-label">Issued</label>
            <input type="date" class="form-control" id="issued" />
          </div>

          <div class="col-6 mb-3">
            <label for="expires" class="form-label">Expires</label>
            <input type="date" class="form-control" id="expires" />
          </div>

          <div class="container">
            <a onclick="displayPubCred()" class="btn btn-primary">Preview</a>
          </div>
        </form>
      </div>
      <!-- /page -->

      <script>
        function previewFile() {
          const preview = document.querySelector("#logoPreview");

          // files that user has chosen
          var all_files = document.querySelector("#logoFile").files;
          if (all_files.length == 0) {
            alert("Error : No file selected");
            return;
          }

          // first file selected by user
          var file = all_files[0];

          // files types allowed
          console.log("File type", file.type);
          var allowed_types = ["image/png", "image/jpg", "image/jpeg"];
          if (allowed_types.indexOf(file.type) == -1) {
            alert(`Error : Incorrect file type ${file.type}`);
            return;
          }

          // Max 2 MB allowed
          var max_size_allowed = 2 * 1024 * 1024;
          if (file.size > max_size_allowed) {
            alert("Error : Exceeded size 2MB");
            return;
          }

          // file validation is successfull
          // we will now read the file

          const reader = new FileReader();

          reader.addEventListener(
            "load",
            function () {
              // convert image file to base64 string
              preview.src = reader.result;
              preview.style.display = "block";
            },
            false
          );

          if (file) {
            reader.readAsDataURL(file);
          }
        }

        async function displayPubCred() {
          let pubcredLogo = document.querySelector("#logoPreview").src;
          document.querySelector("#pubcredLogo").src = pubcredLogo;

          let pubcredTitle = document.querySelector("#declName").value;
          document.querySelector("#pubcredTitle").innerHTML = pubcredTitle;

          let pubcredLi1 = document.querySelector("#decl1").checked;
          console.log("List item 1:", pubcredLi1);
          if (pubcredLi1) {
            document.querySelector("#pubcredLi1").innerHTML =
              "Cumple Protocolos Sanitarios";
          }

          let pubcredLi2 = document.querySelector("#decl2").checked;
          if (pubcredLi2) {
            document.querySelector("#pubcredLi2").innerHTML =
              "Cumple Test PcR Q Empleados";
          }

          let pubcredLi3 = document.querySelector("#decl3").checked;
          if (pubcredLi3) {
            document.querySelector("#pubcredLi3").innerHTML =
              "Cumple Protocolo PoCs";
          }

          let pubcredIssued = document.querySelector("#issued").value;
          document.querySelector("#pubcredIssued").innerHTML = pubcredIssued;

          let pubcredExpires = document.querySelector("#expires").value;
          document.querySelector("#pubcredExpires").innerHTML = pubcredExpires;

          await gotoPage("#pubcred");
        }
      </script>

      <!-- =========================================== -->
      <!-- PUBCRED PAGE for entities                   -->
      <!-- =========================================== -->
      <script>
        // Register the page function
        pages["#pubcred"] = async function (pageData) {
          console.log("=> Inside pubcred");
        };
      </script>

      <!-- Each page is a simple container with the special class jrmpage -->
      <!-- Page transitions are implemented in javascript hiding all except the one to show -->
      <div id="pubcred" class="jrmpage container">
        <div class="card my-3 shadow">
          <img id="pubcredLogo" src="" class="card-img-top" alt="logo" />

          <div class="card-body">
            <h5 id="pubcredTitle" class="card-title">
              ESTABLECIMIENTO Covid Safe Responsable
            </h5>
          </div>

          <!-- <ul class="list-group list-group-flush">
                    <li id="pubcredLi1" class="list-group-item"></li>
                    <li id="pubcredLi2" class="list-group-item"></li>
                    <li id="pubcredLi3" class="list-group-item"></li>
                </ul> -->

          <ul>
            <li id="pubcredLi1"></li>
            <li id="pubcredLi2"></li>
            <li id="pubcredLi3"></li>
          </ul>

          <div class="card-body">
            <p>
              <strong>Issued: <span id="pubcredIssued"></span></strong>
            </p>
            <p>
              <strong>Expires: <span id="pubcredExpires"></span></strong>
            </p>
          </div>

          <div class="card-body">
            <a href="#" class="card-link">Ir a la web</a>
          </div>
        </div>
      </div>
      <!-- /page -->

      <!-- ============================================================================
        CREDENTIAL DETAILS PAGE

        Displays details about a given credential
        ============================================================================ -->
      <div id="credentialDetailsPage" class="jrmpage container">
        <!-- Error display in case of errors. Hidden initially -->
        <div
          id="credentialDetailsPageError"
          class="card shadow"
          style="display: none"
        >
          <div class="card-body">
            <h5 class="card-title">Error</h5>
            <p class="card-text"></p>
            <a onclick="history.back()" class="btn btn-primary">Back</a>
          </div>
        </div>

        <!-- *********************************************************************** -->
        <!-- This the placeholder where the credential will be displayed dynamically -->
        <div id="credentialDetailsPlaceHolder" class="container"></div>
        <!-- *********************************************************************** -->
      </div>
      <!-- /page -->

      <!-- =========================================== -->
      <!-- FAKE ISSUER HOME PAGE                            -->
      <!-- =========================================== -->
      <div id="issuerHome" class="jrmpage container">
        <div id="issuer_cred_list"></div>
      </div>
      <!-- /page -->

      <!-- =========================================== -->
      <!-- PUBCREDS ISSUER PAGE                            -->
      <!-- =========================================== -->
      <div id="pubcreds" class="jrmpage container">
        <div id="pub_cred_list"></div>
      </div>
      <!-- /page -->

      <!-- =========================================== -->
      <!-- DELETE CREDENTIAL MODAL -->
      <!-- =========================================== -->

      <div class="modal" id="passengerDeleteCredModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Are you sure?</h5>
              <button
                type="button"
                class="close"
                data-dismiss="modal"
                aria-label="Close"
              >
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <p>Confirm that you want to delete this credential.</p>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary btn-lg"
                data-dismiss="modal"
              >
                Cancel
              </button>
              <button
                type="button"
                class="btn btn-danger btn-lg"
                id="deleteCredentialButton"
              >
                Delete
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- =========================================== -->
      <!-- ERROR DISPLAY MODAL                         -->
      <!-- =========================================== -->

      <div class="modal" id="errorDisplayModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">There was an error</h5>
              <button
                type="button"
                class="close"
                data-dismiss="modal"
                aria-label="Close"
              >
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <div id="errorDisplayText"></div>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary btn-lg"
                data-dismiss="modal"
              >
                Cancel
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- =========================================== -->
      <!-- =========================================== -->
      <!-- =========================================== -->
      <!-- =========================================== -->

      <!-- =========================================== -->
      <!-- ADMIN PAGE                                  -->
      <!-- =========================================== -->
      <div id="admin" class="jrmpage container">
        <div class="alert alert-danger" role="alert">
          <p>
            <strong>Warning! </strong>Use these functions only if you know the
            implications or if instructed by operations personnel.
          </p>
        </div>

        <div class="card my-3 shadow">
          <a onclick="gotoPage('#logsPage')">
            <div class="card-body">
              <h4 class="card-title">Display logs</h4>
            </div>
          </a>
        </div>

        <div class="card mb-3 shadow">
          <a onclick="gotoPage('#diagnosticsPage')">
            <div class="card-body">
              <h4 class="card-title">Run diagnostics</h4>
            </div>
          </a>
        </div>

        <div class="card mb-3 shadow">
          <a id="adminClearLogsButton">
            <div class="card-body">
              <h4 class="card-title">Clear logs</h4>
            </div>
          </a>
        </div>

        <div class="card mb-3 shadow">
          <a id="adminResetDatabaseButton">
            <div class="card-body">
              <h4 class="card-title">Reset application</h4>
            </div>
          </a>
        </div>
      </div>
      <!-- /page -->

      <!-- =========================================== -->
      <!-- DISPLAY LOGS                                -->
      <!-- =========================================== -->
      <div id="logsPage" class="jrmpage container">
        <div class="container">
          <div class="placeHolder"></div>
        </div>
      </div>
      <!-- /page -->

      <!-- =========================================== -->
      <!-- DIAGNOSTICS                                 -->
      <!-- =========================================== -->
      <div id="diagnosticsPage" class="jrmpage container">
        <div class="placeHolder"></div>
      </div>
      <!-- /page -->
    </div>

    <!-- =========================================== -->
    <!-- =========================================== -->
    <!-- =========================================== -->
    <!-- =========================================== -->
    
    <script>
        // This is the first javascript code executed in the application, even before
        // The html is executed. The code should be kept to a minimum.
  
        // This is the array of pages in the application
        // Each page should register a handler to execute pageEnter transitions
        // registration is done at each page definition
  
        // The app can be invoked in different ways:
        // 1. Just the domain name. This is the default and the functionality is the
        //   passenger wallet, implemented in the file "index.html".
        // 2. As "verifier.html" or "pubcred.html". Those are files exactly identical to
        //   the "index.html" but they behave as the name suggests. It is a convenience
        //   method to invoke the other specialised functionalities.
        // 3. With a URL search parameter "id", like
        //   "https://www.lanzarotesafe.org/?id=123456". In this case, the passenger
        //   wallet retrieves automatically the VC specified by the "id".
        // 4. Finally, with a URL parameter "page", specifying the page inside the app to
        //   invoke. This is not intended for end-users, but givess access to functionality not accessible otherwise, like the admin screens.
  
        // Get the pathname used to invoke the app, eg.: /admin.html
        var mypathname = window.location.pathname;
  
        // Get the search parameters, eg.: ?page=admin
        var paramsString = window.location.search;
        var searchParams = new URLSearchParams(paramsString);
  
        // The default home page is the Passenger credential list (the wallet)
        var homePage = "#credentialListPage";

        // Check for query string specifying the initial page
        if (searchParams.get("verifier") !== null) {
            // ?verifier
            homePage = "#verifierScanQR";
        } else if (searchParams.get("demo") !== null) {
            // ?demo
            homePage = "#demo";
        } else if (searchParams.get("admin") !== null) {
            // ?admin
            homePage = "#admin";
        } else if (searchParams.get("pubcred") !== null) {
            // ?pubcred
            homePage = "#pubcreds";
        }
  
        // Get the initial page to display if it was specified. Priority is:
        // 1. "pathName" if it is one of pubcred, admin, demo, tubo.
        // 2. "page" in URl params.
        // 3. default "homePage" if nothing was specified or the page does not exist.
  
  
        // This function hides/displays the headers depending on the page
        function headerBrandBack(flag) {
          if (flag == true) {
            $("#headerBrandNormal").hide();
            $("#headerBrandBack").show();
          } else {
            $("#headerBrandNormal").show();
            $("#headerBrandBack").hide();
          }
        }
  
        // Screen types for display of QR data
        const ST_PASSENGER_SCAN = "fromPassengerScan";
        const ST_VERIFIER_SCAN = "fromVerifierScan";
        const ST_NORMAL = "normal";
  
        // The global variable holding the media stream for the video camera
        var globalStream = undefined;
  
        // This is used to stop the media tracks in a global variable,
        // to ensure that the camera is never activated if the active page does not use it
        function stopAllMediaTracks() {
          // Check if the gloval variable has a stream
          if (globalStream) {
            // Stop the media stream
  
            tracks = globalStream.getTracks();
            tracks[0].stop();
            // for (let i = 0; i < tracks.length; i++) {
            //     tracks[i].stop()
            // }
            globalStream = undefined;
          }
          return;
        }
  
        // Listen for PopStateEvent (Back or Forward buttons are clicked)
        window.addEventListener("popstate", async function (event) {
          // Set defaults
          var pageName = homePage;
          var pageData = undefined;
  
          // Get current state data if not null
          var state = event.state;
          if (state != null) {
            pageName = state.pageName;
            pageData = state.pageData;
          }
          console.log("Popstate: ", pageName);
  
          // Process the page transition
          await processPageEntered(pageName, pageData);
        });
  
        // Handle page transition
        async function processPageEntered(pageName, pageData) {
          // Hide all pages of the application. Later we unhide the one we are entering
          $(".jrmpage").hide();
          // Hide the loader
          $("#loader").hide();
          // Set the default status of the Navbar
          headerBrandBack(false);
  
          // Stop any active stream
          stopAllMediaTracks();
  
          // If the hash is not a registered page, go to the home page
          if (pages[pageName] == null) {
            pageName = homePage;
          }
  
          // Make sure the page is at the top
          window.scrollTo(0, 0);
  
          // Show the page before invoking the page enter event
          $(pageName).show();
  
          // Invoke the registered function when page has entered
          // This will allow the page to create dynamic content
          await pages[pageName](pageData);
        }
  
        async function gotoPage(pageName, pageData) {
          // If the hash is not a registered page, go to the home page
          if (pages[pageName] == null) {
            myerror("Target page does not exist: ", pageName);
            return;
          }
  
          console.log("CURRENT STATE", window.history.state);
          console.log("Navigating to ", pageName, pageData);
  
          // Create a new history state
          window.history.pushState(
            { pageName: pageName, pageData: pageData },
            `${pageName}`
          );
  
          // Process the page transition
          await processPageEntered(pageName, pageData);
        }
      </script>
  


    <!-- =========================================== -->
    <!-- TEMPLATES FOR CREDENTIALS                   -->
    <!-- =========================================== -->

    <!-- Template management -->
    <script src="js/handlebars.js"></script>

    <script>
      // The list of credential templates supported
      var credentialTemplatesName = [
        "covidTestResult",
        "vaccinationCredential",
        "publicCredential",
        "ukimmigration",
      ];

      Handlebars.registerHelper("toUTCDate", function (dateStamp) {
        var cred_date = new Date(dateStamp * 1000);
        return cred_date.toUTCString();
      });

      Handlebars.registerHelper("toDate", function (dateStamp) {
        var d = new Date(dateStamp * 1000);
        var year = d.getFullYear();
        var month = d.getMonth() + 1;
        month = month.toString().padStart(2, "0");
        var day = d.getDate().toString().padStart(2, "0");
        var hours = d.getHours().toString().padStart(2, "0");
        var minutes = d.getMinutes().toString().padStart(2, "0");
        var seconds = d.getSeconds().toString().padStart(2, "0");

        return (
          year +
          "-" +
          month +
          "-" +
          day +
          "T" +
          hours +
          ":" +
          minutes +
          ":" +
          seconds
        );
      });

      var credentialTemplatesCompiled = [];

      function compileCredentialTemplates() {
        for (i = 0; i < credentialTemplatesName.length; i++) {
          var templateName = credentialTemplatesName[i];
          var templateSource = document.getElementById(templateName).innerHTML;
          var compiledTemplate = Handlebars.compile(templateSource);

          credentialTemplatesCompiled.push(compiledTemplate);
        }
      }

      function getTemplate(name) {
        console.log("template name", name);
        index = credentialTemplatesName.indexOf(name);
        if (index == -1) {
          return undefined;
        }
        return credentialTemplatesCompiled[index];
      }
    </script>

    <script
      class="credentialTemplate"
      id="publicCredential"
      type="text/x-handlebars-template"
    >

      {{#with vc.credentialSubject.publicCredential}}


      <div class="card my-3 shadow">

              <div class="flex d-flex align-items-center" style="height: 120px;">
                  <img id="pubcredLogo" src="{{entity.logo}}" class="float-left" style="height: 120px;" alt="logo">
              </div>

          <div class="card-body">
              <h5 class="card-title">{{entity.name}}</h5>
              <h5 class="card-title">{{name}}</h5>
          </div>

          <ul>
              {{#each self_declarations}}
              <li>{{this}}</li>
              {{/each}}
          </ul>

      {{/with}}

          <div class="card-body">
              <p><strong>Issued: {{toDate iat}}</strong></p>
              <p><strong>Expires: {{toDate exp}}</strong></p>
              <a href="{{vc.credentialSubject.publicCredential.entity.url}}" class="card-link">Go to website</a>
          </div>

      </div>
    </script>

    <script
      class="credentialTemplate"
      id="covidTestResult"
      type="text/x-handlebars-template"
    >
      {{#with vc.credentialSubject.covidTestResult}}
        <div class="container">

          <!-- The content of the container is a template of a credential, filled with
            sample data. The individual fields inside the template are modified by the 
            functions receiving and retrieving actual credential data (in JSON format) -->

          <div class="row">
            <div class="col">
              <div class="row">
                <p class="etiqueta">Name</p>
              </div>
              <div class="row">
                <p class="valor text-break" id="name">{{patient.name}}</p>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col">
              <div class="row">
                <p class="etiqueta">Date of birth</p>
              </div>
              <div class="row">
                <p class="valor" id="dob">{{patient.dob}}</p>
              </div>
            </div>
            <div class="col">
              <div class="row">
                <p class="etiqueta">Test number</p>
              </div>
              <div class="row">
                <p class="valor text-break" id="testnum">{{analysis.id}}</p>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col">
              <div class="row">
                <p class="etiqueta">Test type</p>
              </div>
              <div class="row">
                <p class="valor text-break" id="testtype">{{analysis.type}}</p>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col">
              <div class="row">
                <p class="etiqueta">Test date</p>
              </div>
              <div class="row">
                <p class="valor" id="testdate">{{toDate analysis.date}}</p>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col">
              <div class="row">
                <p class="etiqueta">Lab name</p>
              </div>
              <div class="row">
                <p class="valor" id="labname">{{lab.name}}</p>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col">
              <div class="row">
                <p class="etiqueta">Lab address</p>
              </div>
              <div class="row">
                <p class="valor" id="labaddress">{{lab.address}}</p>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col">
              <div class="row">
                <p class="etiqueta">Lab phone</p>
              </div>
              <div class="row">
                <p class="valor" id="labphone">{{lab.phone}}</p>
              </div>
            </div>
          </div>

        </div>
      {{/with}}
    </script>

    <script
      class="credentialTemplate"
      id="vaccinationCredential"
      type="text/x-handlebars-template"
    >
      {{#with vc.credentialSubject.vaccinationCredential}}
        <div class="container">

          <!-- The content of the container is a template of a credential, filled with
            sample data. The individual fields inside the template are modified by the 
            functions receiving and retrieving actual credential data (in JSON format) -->

          <!-- PERSON IDENTIFICATION CARD -->

          <div class="row">
            <div class="col">
              <div class="row">
                <p class="etiqueta">Name:</p>
              </div>
              <div class="row">
                <p class="valor">{{patient.name}}</p>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col">
              <div class="row">
                <p class="etiqueta">ID:</p>
              </div>
              <div class="row">
                <p class="valor">{{patient.idnumber}}</p>
              </div>
            </div>
            <div class="col">
              <div class="row">
                <p class="etiqueta">Birth date</p>
              </div>
              <div class="row">
                <p class="valor">{{patient.dob}}</p>
              </div>
            </div>
          </div>

          <!-- VACCINATION CARD -->

          <div class="row">
            <div class="col">
              <div class="row">
                <p class="etiqueta">Disease target:</p>
              </div>
              <div class="row">
                <p class="valor">{{vaccination.disease}}</p>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col">
              <div class="row">
                <p class="etiqueta">Vaccine:</p>
              </div>
              <div class="row">
                <p class="valor">{{vaccination.vaccine}}</p>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col">
              <div class="row">
                <p class="etiqueta">Product:</p>
              </div>
              <div class="row">
                <p class="valor">{{vaccination.product}}</p>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col">
              <div class="row">
                <p class="etiqueta">Auth holder:</p>
              </div>
              <div class="row">
                <p class="valor">{{vaccination.auth_holder}}</p>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col">
              <div class="row">
                <p class="etiqueta">Dose:</p>
              </div>
            </div>
            <div class="col">
              <div class="row">
                <p class="valor">{{vaccination.dose_number}}</p>
              </div>
            </div>
            <div class="col">
              <div class="row">
                <p class="etiqueta">of:</p>
              </div>
            </div>
            <div class="col">
              <div class="row">
                <p class="valor">{{vaccination.total_doses}}</p>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col">
              <div class="row">
                <p class="etiqueta">Batch:</p>
              </div>
              <div class="row">
                <p class="valor">{{vaccination.batch}}</p>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col">
              <div class="row">
                <p class="etiqueta">Date:</p>
              </div>
              <div class="row">
                <p class="valor">{{toDate vaccination.date}}</p>
              </div>
            </div>
            <div class="col">
              <div class="row">
                <p class="etiqueta">Next date:</p>
              </div>
              <div class="row">
                <p class="valor">{{toDate vaccination.next_date}}</p>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col">
              <div class="row">
                <p class="etiqueta">Center:</p>
              </div>
              <div class="row">
                <p class="valor">{{vaccination.center}}</p>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col">
              <div class="row">
                <p class="etiqueta">Health professional:</p>
              </div>
              <div class="row">
                <p class="valor">{{vaccination.professional}}</p>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col">
              <div class="row">
                <p class="etiqueta">Country:</p>
              </div>
              <div class="row">
                <p class="valor">{{vaccination.country}}</p>
              </div>
            </div>
          </div>

        </div>
      {{/with}}
    </script>

    <script
      class="credentialTemplate"
      id="ukimmigration"
      type="text/x-handlebars-template"
    >
      <div class="container">

        <!-- The content of the container is a template of a credential, filled with
              sample data. The individual fields inside the template are modified by the 
              functions receiving and retrieving actual credential data (in JSON format) -->

        <!-- PERSON IDENTIFICATION CARD -->
        <div class="card mb-3">
          <header class="card-header">
            <p class="card-header-title">
              UK Visas & Immigration
            </p>
          </header>
          <div class="card-content">
            <div class="content">

              <p>Name: <b>{{ln}}/{{fn}}</b></p>
              <p>Passport: <b>{{di}}</b></p>
              <p>Date: <b>{{ts}}</b></p>
              <p>Reference: <b>{{rf}}</b></p>

              {{#each tg}}
                <p>Phone: <b>+{{this.code}} {{this.number}}</b></p>

              {{/each}}

              <p>Address: <b>{{qa}}</b></p>

            </div>
          </div>
        </div>

      </div>
    </script>

    <!-- ================================ -->
    <!-- END TEMPLATES FOR CREDENTIALS    -->
    <!-- ================================ -->

    <script type="module">
        import {Workbox} from 'https://storage.googleapis.com/workbox-cdn/releases/6.1.5/workbox-window.prod.mjs'
        window.Workbox = Workbox
    </script>

    <!-- ================================ -->
    <!-- APPLICATION SCRIPTS              -->
    <!-- ================================ -->

    <!-- Logging -->
    <script src="js/loglevel.min.js"></script>

    <!-- Database layer on top of IndexedDB -->
    <script src="js/dexie.js"></script>

    <!-- JQuery -->
    <script src="js/jquery-3.5.1.min.js"></script>

    <!-- Bootstrap 4 -->
    <!-- <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-Piv4xVNRyMGpqkS2by6br4gNJ7DXjqk09RmUpJ8jgGtD7zP9yug3goQfGII0yAns"
        crossorigin="anonymous"></script> -->
    <script src="js/bootstrap.bundle.min.js"></script>

    <!-- <script src="js/base45-js.js"></script> -->

    <!-- <script src="js/cose.js"></script> -->

    <script src="js/pako.js"></script>

    <!-- Generate a QR -->
    <script src="js/easy.qrcode.min.js"></script>

    <!-- Scan a QR -->
    <script src="js/jsQR.js"></script>

    <!-- Scan the barcode in the test tube -->
    <script type="text/javascript" src="js/zxing.js"></script>

    <!-- The Application logic -->
    <!-- <script src="js/main.js"></script> -->

    <script type="module" src="./js/main.js"></script>
  </body>
</html>
